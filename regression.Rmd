---
title: "Kirstie_Regression"
author: "Kirstie Turnbull"
date: "11/29/2020"
output: html_document
---

Goal is to run this model: "log(E(cases_t)) = offset(log(population))+ mobility_t + mask_use_t + demographics + political party + spline(t)" OR "Cases ~ bla + bs(time, knots = one knot every 30 days)" instead of "spline(t)"

```{r}
library(tidyverse)
library(lubridate)
library(rvest)
library(stringr)
library(zoo)
library(directlabels)
```


```{r}
# population data (same as Anja's)
url <- "https://en.wikipedia.org/wiki/List_of_states_and_territories_of_the_United_States_by_population"
h <- read_html(url)
```

```{r}
# looking for the first table on the page
tab <- h %>% html_nodes("table") %>% .[1] %>% html_table(fill = TRUE) %>% .[[1]]
```

```{r}
# narrow to state/population
pop_states <- tab %>% select("State","Census population")
# delete extra rows from wikipedia
pop_states <- pop_states[2:57,]
```

```{r}
# fix variable types of population data
pop_states$State <- as.factor(pop_states$State)
pop_states$`Census population` <- as.numeric(str_replace_all(pop_states$`Census population`, ",", ""))
# do we even want Guam, American Samoa, etc.?
```

```{r}
# fix variable name for population data
colnames(pop_states) <- c("state","population")
```

Okay I think this is good enough for population data for now!

Now for mobility data
```{r}
# read it in!
mobility <- read_csv("2020_US_Region_Mobility_report.csv")
```

```{r}
# cut out rows for whole country
mobility <- mobility[285:715006,]
```

```{r}
# remove lots of extra columns
mobility <- mobility %>% select("sub_region_1", "date", "retail_and_recreation_percent_change_from_baseline", "grocery_and_pharmacy_percent_change_from_baseline", "parks_percent_change_from_baseline", "transit_stations_percent_change_from_baseline", "workplaces_percent_change_from_baseline")
```

```{r}
# update state column name
colnames(mobility)[1] <- "state"
```

```{r}
# update state variable type
mobility$state <- as.factor(mobility$state)
```

Okay, that's enough for mobility data, now for COVID data:
```{r}
# same as Anja's!
url <- "https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-states.csv"
covid <- read_csv(url)
```

```{r}
# make state a factor
covid$state <- as.factor(covid$state)
```

Still need governor's political party/demographic/mask-use data before regression!

```{r}
# political party
url <- "https://en.wikipedia.org/wiki/List_of_current_United_States_governors"
h <- read_html(url)
```

```{r}
# looking for the first table on the page
tab <- h %>% html_nodes("table") %>% .[1] %>% html_table(fill = TRUE) %>% .[[1]]
```

```{r}
# remove unnecessary rows
gov_political <- tab[2:51,1:5]
```

```{r}
# fix column names
colnames(gov_political)[1] <- "state"
colnames(gov_political)[5] <- "gov_party"
```

```{r}
# narrow to only the columns we care about
gov_political <- gov_political %>% select("state","gov_party")
```

```{r}
# fix weird entries for Minnesota and West Virginia
gov_political[23,2] <- "Democratic"
gov_political[48,2] <- "Republican"
```

```{r}
# make state and political party factors 
gov_political$state <- as.factor(gov_political$state)
gov_political$gov_party <- as.factor(gov_political$gov_party)
```

Done with governor's political party! Now taking a look at mask data/demographic data

Population density 
```{r}
# population data (same as Anja's)
url <- "https://en.wikipedia.org/wiki/Demographics_of_the_United_States"
h <- read_html(url)
```

```{r}
# looking for the first table on the page
tab <- h %>% html_nodes("table") %>% .[28] %>% html_table(fill = TRUE) %>% .[[1]]
```

```{r}
racial_demog <- tab
```

```{r}
racial_demog$`State or territory` <- as.factor(racial_demog$`State or territory`)
racial_demog$`Black orAfrican American` <- str_replace_all(racial_demog$`Black orAfrican American`, "%", "")
racial_demog$`Black orAfrican American` <- as.numeric(racial_demog$`Black orAfrican American`)
```

```{r}
mask <- read.csv("covidcast-fb-survey-smoothed_wearing_mask-2020-04-06-to-2020-12-01.csv")
```

```{r}
colnames(racial_demog)[1] <- "state"
```

```{r}
join1 <- left_join(gov_political,pop_states,by="state")
```

```{r}
join2 <- left_join(join1,racial_demog,by="state")
```

```{r}
join3 <- left_join(mobility,join2,by="state")
```

```{r}
final_df <- left_join(join3,covid,by=c("state","date"))
```

```{r}
final_df$time <- as.numeric(final_df$date - ymd("2020-02-14"))
```

```{r}
final_df <- final_df %>% select(state,date,retail_and_recreation_percent_change_from_baseline,grocery_and_pharmacy_percent_change_from_baseline,parks_percent_change_from_baseline,transit_stations_percent_change_from_baseline,workplaces_percent_change_from_baseline,gov_party,population,`Black orAfrican American`,cases,time)
```

```{r}
final_df <- final_df[complete.cases(final_df),]
```

```{r}
summary(final_df)
```

trying a first attempt at regression now, mask data not looking super usable

need to update date variables to be time (day = 1 to day = whatever)


```{r}
library(splines)
library(splines2)
mod1 <- lm(log(cases) ~ retail_and_recreation_percent_change_from_baseline + 
             grocery_and_pharmacy_percent_change_from_baseline + 
             parks_percent_change_from_baseline + 
             transit_stations_percent_change_from_baseline +
             workplaces_percent_change_from_baseline +
             gov_party + 
             `Black orAfrican American` +
             bSpline(time,10),
             offset = log(population), 
             data=final_df
             )
summary(mod1)
```

Interesting that cases decreased in states where there is, going to add population density before splitting into training/testing sets because that could be a confounder.

```{r}
# population data (same as Anja's)
url <- "https://en.wikipedia.org/wiki/List_of_states_and_territories_of_the_United_States_by_population_density"
h <- read_html(url)
# looking for the first table on the page
tab <- h %>% html_nodes("table") %>% .[2] %>% html_table(fill = TRUE) %>% .[[1]]
```

```{r}
pop_density <- tab
```

```{r}
pop_density <- pop_density[2:57,c(1,4)]
```

```{r}
colnames(pop_density)[1] <- "state"
colnames(pop_density)[2] <- "density"
```

```{r}
pop_density <- pop_density %>% filter(!state %in% c("District of Columbia", "Puerto Rico", "Guam", "US Virgin Islands", "American Samoa", "Northern Mariana Islands"))
```

```{r}
pop_density$density <- as.numeric(pop_density$density)
```

```{r}
final_df2 <- left_join(final_df,pop_density,by="state")
```


Split into Training/Testing Sets:
```{r}
train_set <- final_df2[1:113973,]
test_set <- final_df2[113974:127050,]
```

```{r}
mod2 <- lm(log(cases) ~ retail_and_recreation_percent_change_from_baseline + 
             grocery_and_pharmacy_percent_change_from_baseline + 
             parks_percent_change_from_baseline + 
             transit_stations_percent_change_from_baseline +
             workplaces_percent_change_from_baseline +
             gov_party + 
             `Black orAfrican American` +
             density +
             bSpline(time,10),
             offset = log(population), 
             data=train_set
             )
summary(mod2)
```

```{r}
mod2_preds <- predict.lm(mod2,test_set)
plot(exp(mod2_preds),test_set$cases)
abline(0,1)
sqrt(mean((test_set$cases - exp(mod2_preds))^2))
```

Note: it makes sense that this is so bad for prediction because our test set is the month of November, and there was a massive spike in November.

```{r}
mod3 <- lm(log(cases) ~ retail_and_recreation_percent_change_from_baseline + 
             grocery_and_pharmacy_percent_change_from_baseline + 
             parks_percent_change_from_baseline + 
             transit_stations_percent_change_from_baseline +
             workplaces_percent_change_from_baseline +
             gov_party + 
             `Black orAfrican American` +
             density +
             bSpline(time,8),
             offset = log(population), 
             data=train_set
             )
summary(mod3)
mod3_preds <- predict.lm(mod3,test_set)
plot(exp(mod3_preds),test_set$cases)
abline(0,1)
sqrt(mean((test_set$cases - exp(mod3_preds))^2))
```

```{r}
mod4 <- lm(log(cases) ~ retail_and_recreation_percent_change_from_baseline + 
             grocery_and_pharmacy_percent_change_from_baseline + 
             parks_percent_change_from_baseline + 
             transit_stations_percent_change_from_baseline +
             workplaces_percent_change_from_baseline +
             gov_party + 
             `Black orAfrican American` +
             density +
             bSpline(time,12),
             offset = log(population), 
             data=train_set
             )
summary(mod4)
mod4_preds <- predict.lm(mod4,test_set)
plot(exp(mod4_preds),test_set$cases)
abline(0,1)
sqrt(mean((test_set$cases - exp(mod4_preds))^2))
```

```{r}
mod5 <- lm(log(cases) ~ retail_and_recreation_percent_change_from_baseline + 
             grocery_and_pharmacy_percent_change_from_baseline + 
             parks_percent_change_from_baseline + 
             transit_stations_percent_change_from_baseline +
             workplaces_percent_change_from_baseline +
             `Black orAfrican American` +
             density +
             bSpline(time,12),
             offset = log(population), 
             data=train_set
             )
summary(mod5)
mod5_preds <- predict.lm(mod5,test_set)
plot(exp(mod5_preds),test_set$cases)
abline(0,1)
sqrt(mean((test_set$cases - exp(mod5_preds))^2))
```

```{r}
mod6 <- lm(log(cases) ~ retail_and_recreation_percent_change_from_baseline + 
             grocery_and_pharmacy_percent_change_from_baseline + 
             parks_percent_change_from_baseline + 
             transit_stations_percent_change_from_baseline +
             workplaces_percent_change_from_baseline +
             density +
             bSpline(time,12),
             offset = log(population), 
             data=train_set
             )
summary(mod6)
mod6_preds <- predict.lm(mod6,test_set)
plot(exp(mod6_preds),test_set$cases)
abline(0,1)
sqrt(mean((test_set$cases - exp(mod6_preds))^2))
```

```{r}
mod7 <- lm(log(cases) ~ retail_and_recreation_percent_change_from_baseline + 
             grocery_and_pharmacy_percent_change_from_baseline + 
             parks_percent_change_from_baseline + 
             transit_stations_percent_change_from_baseline +
             workplaces_percent_change_from_baseline +
             bSpline(time,12),
             offset = log(population), 
             data=train_set
             )
summary(mod7)
mod7_preds <- predict.lm(mod7,test_set)
plot(exp(mod7_preds),test_set$cases)
abline(0,1)
sqrt(mean((test_set$cases - exp(mod7_preds))^2))
```

```{r}
mod8 <- lm(log(cases) ~ retail_and_recreation_percent_change_from_baseline + 
             grocery_and_pharmacy_percent_change_from_baseline + 
             transit_stations_percent_change_from_baseline +
             workplaces_percent_change_from_baseline +
             density +
             bSpline(time,12),
             offset = log(population), 
             data=train_set
             )
summary(mod8)
mod8_preds <- predict.lm(mod8,test_set)
plot(exp(mod8_preds),test_set$cases)
abline(0,1)
sqrt(mean((test_set$cases - exp(mod8_preds))^2))
```

```{r}
mod9 <- lm(log(cases) ~  
             grocery_and_pharmacy_percent_change_from_baseline + 
             transit_stations_percent_change_from_baseline +
             parks_percent_change_from_baseline +
             workplaces_percent_change_from_baseline +
             density +
             bSpline(time,12),
             offset = log(population), 
             data=train_set
             )
summary(mod9)
mod9_preds <- predict.lm(mod9,test_set)
plot(exp(mod9_preds),test_set$cases)
abline(0,1)
sqrt(mean((test_set$cases - exp(mod9_preds))^2))
```

```{r}
mod10 <- lm(log(cases) ~  
             transit_stations_percent_change_from_baseline +
             parks_percent_change_from_baseline +
             workplaces_percent_change_from_baseline +
             density +
             bSpline(time,12),
             offset = log(population), 
             data=train_set
             )
summary(mod10)
mod10_preds <- predict.lm(mod10,test_set)
plot(exp(mod10_preds),test_set$cases)
abline(0,1)
sqrt(mean((test_set$cases - exp(mod10_preds))^2))
```

```{r}
mod11 <- lm(log(cases) ~  
             grocery_and_pharmacy_percent_change_from_baseline + 
             parks_percent_change_from_baseline +
             workplaces_percent_change_from_baseline +
             density +
             bSpline(time,12),
             offset = log(population), 
             data=train_set
             )
summary(mod11)
mod11_preds <- predict.lm(mod11,test_set)
plot(exp(mod11_preds),test_set$cases)
abline(0,1)
sqrt(mean((test_set$cases - exp(mod11_preds))^2))
```

```{r}
mod9 <- lm(log(cases) ~  
             grocery_and_pharmacy_percent_change_from_baseline + 
             transit_stations_percent_change_from_baseline +
             parks_percent_change_from_baseline +
             workplaces_percent_change_from_baseline +
             density +
             bSpline(time,12),
             offset = log(population), 
             data=train_set
             )
summary(mod9)
mod9_preds <- predict.lm(mod9,test_set)
plot(exp(mod9_preds),test_set$cases)
abline(0,1)
sqrt(mean((test_set$cases - exp(mod9_preds))^2))
```

